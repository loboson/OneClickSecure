---
- name: ë³´ì•ˆ ì¤€ìˆ˜ CentOS ì ê²€ í”Œë ˆì´ë¶
  hosts: localhost
  gather_facts: yes
  connection: local
  
  tasks:
    # ===========================================
    # ê³„ì •ê´€ë¦¬: í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í™•ì¸
    # ===========================================
    - name: "[ê³„ì •ê´€ë¦¬] í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í™•ì¸"
      command: "whoami"
      register: current_user
      changed_when: false
      
    - name: "[ê³„ì •ê´€ë¦¬] ì‚¬ìš©ì ID í™•ì¸"
      command: "id"
      register: user_id
      changed_when: false
      
    # ===========================================
    # ì„œë¹„ìŠ¤: ë°©í™”ë²½ ìƒíƒœ í™•ì¸
    # ===========================================
    - name: "[ì„œë¹„ìŠ¤] ë°©í™”ë²½ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
      command: "systemctl is-active firewalld"
      register: firewall_status
      changed_when: false
      failed_when: false
      
    - name: "[ì„œë¹„ìŠ¤] ë°©í™”ë²½ í™œì„±í™” ìƒíƒœ í™•ì¸"
      command: "systemctl is-enabled firewalld"
      register: firewall_enabled
      changed_when: false
      failed_when: false
      
    # ===========================================
    # íŒŒì¼ ë° ë””ë ‰í„°ë¦¬: í™ˆ ë””ë ‰í„°ë¦¬ ê¶Œí•œ í™•ì¸
    # ===========================================
    - name: "[íŒŒì¼ê¶Œí•œ] í˜„ì¬ ì‚¬ìš©ì í™ˆ ë””ë ‰í„°ë¦¬ ì •ë³´"
      stat:
        path: "{{ ansible_env.HOME }}"
      register: home_stat
      
    - name: "[íŒŒì¼ê¶Œí•œ] /tmp ë””ë ‰í„°ë¦¬ ê¶Œí•œ í™•ì¸"
      stat:
        path: "/tmp"
      register: tmp_stat
      
    # ===========================================
    # íŒ¨ì¹˜ ì ê²€: íŒ¨í‚¤ì§€ ê´€ë¦¬ì ìƒíƒœ í™•ì¸
    # ===========================================
    - name: "[íŒ¨ì¹˜ì ê²€] YUM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ìƒíƒœ"
      command: "rpm -qa | head -5"
      register: rpm_check
      changed_when: false
      
    - name: "[íŒ¨ì¹˜ì ê²€] ì‹œìŠ¤í…œ ì‹œê°„ í™•ì¸"
      command: "date"
      register: system_date
      changed_when: false
      
    # ===========================================
    # ì¶”ê°€ ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
    # ===========================================
    - name: "[ì‹œìŠ¤í…œ] ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸"
      command: "df -h /"
      register: disk_usage
      changed_when: false
      
    - name: "[ì‹œìŠ¤í…œ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸"
      command: "free -h"
      register: memory_usage
      changed_when: false
      
    - name: "[ì‹œìŠ¤í…œ] ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ìˆ˜ í™•ì¸"
      command: "ps aux | wc -l"
      register: process_count
      changed_when: false
      
    # ===========================================
    # ê²°ê³¼ ì¢…í•© ë° ì¶œë ¥
    # ===========================================
    - name: "ë³´ì•ˆ ì ê²€ ê²°ê³¼ ì¶œë ¥"
      debug:
        msg: |
          ==========================================
          CentOS ë³´ì•ˆ ì ê²€ ê²°ê³¼ (ë³´ì•ˆ ì¤€ìˆ˜ ë²„ì „)
          ==========================================
          
          ğŸ“‹ ì ê²€ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  ì‹œìŠ¤í…œ ì •ë³´: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          ğŸ” ê³„ì • ê´€ë¦¬ ì ê²€:
             - í˜„ì¬ ì‚¬ìš©ì: {{ current_user.stdout }}
             - ì‚¬ìš©ì ì •ë³´: {{ user_id.stdout }}
          
          âš™ï¸  ì„œë¹„ìŠ¤ ì ê²€:
             - ë°©í™”ë²½ ìƒíƒœ: {{ firewall_status.stdout | default('inactive') }}
             - ë°©í™”ë²½ ìë™ì‹œì‘: {{ firewall_enabled.stdout | default('disabled') }}
          
          ğŸ“ íŒŒì¼ ë° ë””ë ‰í„°ë¦¬ ì ê²€:
             - í™ˆ ë””ë ‰í„°ë¦¬ ê¶Œí•œ: {{ home_stat.stat.mode if home_stat.stat.exists else 'N/A' }}
             - /tmp ë””ë ‰í„°ë¦¬ ê¶Œí•œ: {{ tmp_stat.stat.mode }}
          
          ğŸ”„ íŒ¨ì¹˜ ì ê²€:
             - ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ (ìƒìœ„ 5ê°œ): {{ rpm_check.stdout_lines | length }}ê°œ ë¼ì¸ ì¶œë ¥
             - ì‹œìŠ¤í…œ ì‹œê°„: {{ system_date.stdout }}
          
          ğŸ’¾ ì‹œìŠ¤í…œ ìƒíƒœ:
             - ë£¨íŠ¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: {{ disk_usage.stdout_lines[1] if disk_usage.stdout_lines|length > 1 else 'N/A' }}
             - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {{ memory_usage.stdout_lines[1] if memory_usage.stdout_lines|length > 1 else 'N/A' }}
             - ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤: {{ process_count.stdout }}ê°œ
          
    - name: "ì ê²€ ê²°ê³¼ ë¶„ì„"
      debug:
        msg: |
          ==========================================
          ì ê²€ ê²°ê³¼ ë¶„ì„
          ==========================================
          
          âœ… ì–‘í˜¸í•œ ì„¤ì •:
          {% if firewall_status.stdout == 'active' %}   - ë°©í™”ë²½ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤{% endif %}
          {% if home_stat.stat.mode|string|length == 4 and home_stat.stat.mode|string|int <= 755 %}   - í™ˆ ë””ë ‰í„°ë¦¬ ê¶Œí•œì´ ì ì ˆí•©ë‹ˆë‹¤{% endif %}
          
          âš ï¸  ì£¼ì˜ í•„ìš”:
          {% if firewall_status.stdout != 'active' %}   - ë°©í™”ë²½ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤{% endif %}
          {% if process_count.stdout|int > 200 %}   - ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ë§ìŠµë‹ˆë‹¤ ({{ process_count.stdout }}ê°œ){% endif %}
          
          ğŸ¯ ê¶Œì¥ì‚¬í•­:
             - ì •ê¸°ì ì¸ ë³´ì•ˆ ì ê²€ ìˆ˜í–‰
             - ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ í™•ì¸
             - ë¡œê·¸ íŒŒì¼ ëª¨ë‹ˆí„°ë§
          
          ==========================================
          ë³´ì•ˆ ì ê²€ ì™„ë£Œ
          ==========================================